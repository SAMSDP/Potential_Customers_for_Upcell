<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Analytics - CustomerIQ</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="../assets/css/main.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>
    <nav class="sidebar">
        <div class="logo">
            <i data-lucide="trending-up"></i>
            <span>CustomerIQ</span>
        </div>
        <ul class="nav-menu">
            <li><a href="../index.html" class="nav-link" data-page="dashboard">
                <i data-lucide="home"></i>Dashboard
            </a></li>
            <li><a href="analytics.html" class="nav-link active" data-page="analytics">
                <i data-lucide="bar-chart-3"></i>Analytics
            </a></li>
            <li><a href="prediction.html" class="nav-link" data-page="prediction">
                <i data-lucide="brain"></i>Predictions
            </a></li>
            <li><a href="segments.html" class="nav-link" data-page="segments">
                <i data-lucide="users"></i>Segments
            </a></li>
            <li><a href="recommendations.html" class="nav-link" data-page="recommendations">
                <i data-lucide="target"></i>Recommendations
            </a></li>
        </ul>
    </nav>

    <main class="main-content">
        <header class="page-header">
            <h1>Customer Analytics</h1>
            <p>Deep dive into customer behavior patterns and trends</p>
        </header>

        <div class="filters-section" style="background: white; padding: 1.5rem; border-radius: 16px; margin-bottom: 2rem; box-shadow: var(--shadow-md);">
            <h3 style="margin-bottom: 1rem;">Filters</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <div class="form-group">
                    <label class="form-label">Tenure</label>
                    <select class="form-select" id="tenureFilter">
                        <option value="">All Customers</option>
                        <option value="new">New (â‰¤ 12 months)</option>
                        <option value="old">Experienced (> 24 months)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Contract Type</label>
                    <select class="form-select" id="contractFilter">
                        <option value="">All Contracts</option>
                        <option value="month">Monthly</option>
                        <option value="year">Yearly</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Service Type</label>
                    <select class="form-select" id="serviceFilter">
                        <option value="">All Services</option>
                        <option value="fiber">Fiber Optic</option>
                        <option value="dsl">DSL</option>
                        <option value="no">No Internet</option>
                    </select>
                </div>
                <div class="form-group" style="display: flex; align-items: end;">
                    <button class="btn btn-primary" onclick="applyFilters()">
                        <i data-lucide="filter"></i>Apply Filters
                    </button>
                </div>
            </div>
        </div>

        <div class="analytics-grid">
            <div class="charts-row">
                <div class="chart-card">
                    <h3>Call Usage Analysis</h3>
                    <canvas id="usageChart"></canvas>
                </div>

                <div class="chart-card">
                    <h3>Churn Distribution by Contract</h3>
                    <canvas id="churnDistChart"></canvas>
                </div>
            </div>

            <div class="charts-row">
                <div class="chart-card">
                    <h3>Customer Support Metrics</h3>
                    <canvas id="supportChart"></canvas>
                </div>

                <div class="chart-card">
                    <h3>Revenue Distribution</h3>
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>

            <div class="table-section">
                <div class="table-container">
                    <div style="padding: 1.5rem; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: between; align-items: center;">
                        <h3>Customer Details</h3>
                        <button class="btn btn-secondary" onclick="exportCustomerData()">
                            <i data-lucide="download"></i>Export Data
                        </button>
                    </div>
                    <table class="table" id="customersTable">
                        <thead>
                            <tr>
                                <th>Customer ID</th>
                                <th>Tenure</th>
                                <th>Contract</th>
                                <th>Monthly Charges</th>
                                <th>Churn Risk</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="customersTableBody">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script src="../database/telco.js"></script>
    <script src="../database/support.js"></script>
    <script src="../database/cdr.js"></script>
    <script src="../api/customers.js"></script>
    <script src="../assets/js/charts.js"></script>
    <script src="../assets/js/main.js"></script>
    <script>
        let currentData = [];

        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            loadAnalyticsData();
        });

        function loadAnalyticsData(filters = {}) {
            const analytics = window.CustomerAPI.getCustomerAnalytics(filters);
            currentData = analytics.customers;
            
            // Update charts
            window.ChartManager.createUsageAnalysisChart('usageChart', [450, 25, 120]);
            window.ChartManager.createChurnDistributionChart('churnDistChart');
            createSupportMetricsChart();
            createRevenueDistributionChart();
            
            // Update table
            updateCustomersTable(analytics.customers.slice(0, 50)); // Show first 50 customers
        }

        function applyFilters() {
            const filters = {
                tenure: document.getElementById('tenureFilter').value,
                contract: document.getElementById('contractFilter').value,
                service: document.getElementById('serviceFilter').value
            };
            
            loadAnalyticsData(filters);
        }

        function createSupportMetricsChart() {
            const ctx = document.getElementById('supportChart')?.getContext('2d');
            if (!ctx) return;
            
            const supportData = window.supportData || [];
            const issueTypes = ['Technical', 'Billing', 'Service Request', 'Account', 'Product Inquiry'];
            const issueCounts = issueTypes.map(type => 
                supportData.filter(ticket => ticket.issue_type === type).length
            );
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: issueTypes,
                    datasets: [{
                        data: issueCounts,
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createRevenueDistributionChart() {
            const ctx = document.getElementById('revenueChart')?.getContext('2d');
            if (!ctx) return;
            
            const telcoData = window.telcoData || [];
            const ranges = ['<$30', '$30-$60', '$60-$90', '>$90'];
            const rangeCounts = [
                telcoData.filter(c => c.monthly_charges < 30).length,
                telcoData.filter(c => c.monthly_charges >= 30 && c.monthly_charges < 60).length,
                telcoData.filter(c => c.monthly_charges >= 60 && c.monthly_charges < 90).length,
                telcoData.filter(c => c.monthly_charges >= 90).length
            ];
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ranges,
                    datasets: [{
                        label: 'Number of Customers',
                        data: rangeCounts,
                        backgroundColor: '#10b981',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateCustomersTable(customers) {
            const tbody = document.getElementById('customersTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = customers.map(customer => `
                <tr>
                    <td>${customer.customer_id}</td>
                    <td>${customer.tenure} months</td>
                    <td>${customer.contract}</td>
                    <td>$${customer.monthly_charges}</td>
                    <td>
                        <span class="badge ${customer.tenure < 12 ? 'badge-error' : customer.tenure > 24 ? 'badge-success' : 'badge-warning'}">
                            ${customer.tenure < 12 ? 'High' : customer.tenure > 24 ? 'Low' : 'Medium'}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${customer.churn === 'Yes' ? 'badge-error' : 'badge-success'}">
                            ${customer.churn === 'Yes' ? 'Churned' : 'Active'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function exportCustomerData() {
            window.mainApp.downloadData(currentData, 'customer-analytics', 'csv');
            window.mainApp.showNotification('Customer data exported successfully!', 'success');
        }
    </script>
</body>
</html>