<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recommendations - CustomerIQ</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="../assets/css/main.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>
    <nav class="sidebar">
        <div class="logo">
            <i data-lucide="trending-up"></i>
            <span>CustomerIQ</span>
        </div>
        <ul class="nav-menu">
            <li><a href="../index.html" class="nav-link" data-page="dashboard">
                <i data-lucide="home"></i>Dashboard
            </a></li>
            <li><a href="analytics.html" class="nav-link" data-page="analytics">
                <i data-lucide="bar-chart-3"></i>Analytics
            </a></li>
            <li><a href="prediction.html" class="nav-link" data-page="prediction">
                <i data-lucide="brain"></i>Predictions
            </a></li>
            <li><a href="segments.html" class="nav-link" data-page="segments">
                <i data-lucide="users"></i>Segments
            </a></li>
            <li><a href="recommendations.html" class="nav-link active" data-page="recommendations">
                <i data-lucide="target"></i>Recommendations
            </a></li>
        </ul>
    </nav>

    <main class="main-content">
        <header class="page-header">
            <h1>Smart Recommendations</h1>
            <p>AI-powered personalized suggestions for customer engagement</p>
        </header>

        <div class="recommendations-dashboard">
            <!-- Strategy Overview -->
            <div class="strategy-overview">
                <div class="strategy-card loyal">
                    <div class="strategy-header">
                        <i data-lucide="crown"></i>
                        <h3>Loyal Customers</h3>
                    </div>
                    <div class="strategy-content">
                        <p>Premium upsell opportunities and exclusive offers</p>
                        <div class="strategy-stats">
                            <div class="stat">
                                <span class="stat-value" id="loyalRecommendations">0</span>
                                <span class="stat-label">Recommendations</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value" id="loyalConversionRate">0%</span>
                                <span class="stat-label">Conversion Rate</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="strategy-card at-risk">
                    <div class="strategy-header">
                        <i data-lucide="shield"></i>
                        <h3>At-Risk Customers</h3>
                    </div>
                    <div class="strategy-content">
                        <p>Retention offers and service improvement plans</p>
                        <div class="strategy-stats">
                            <div class="stat">
                                <span class="stat-value" id="atRiskRecommendations">0</span>
                                <span class="stat-label">Recommendations</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value" id="retentionRate">0%</span>
                                <span class="stat-label">Retention Rate</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="strategy-card neutral">
                    <div class="strategy-header">
                        <i data-lucide="trending-up"></i>
                        <h3>Neutral Customers</h3>
                    </div>
                    <div class="strategy-content">
                        <p>Engagement campaigns and service discovery</p>
                        <div class="strategy-stats">
                            <div class="stat">
                                <span class="stat-value" id="neutralRecommendations">0</span>
                                <span class="stat-label">Recommendations</span>
                            </div>
                            <div class="stat">
                                <span class="stat-value" id="engagementRate">0%</span>
                                <span class="stat-label">Engagement Rate</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recommendation Filters -->
            <div class="filters-section" style="background: white; padding: 1.5rem; border-radius: 16px; margin: 2rem 0; box-shadow: var(--shadow-md);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3>Filter Recommendations</h3>
                    <button class="btn btn-primary" onclick="generateRecommendations()">
                        <i data-lucide="refresh-cw"></i>Refresh Recommendations
                    </button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Segment</label>
                        <select class="form-select" id="segmentFilter">
                            <option value="">All Segments</option>
                            <option value="loyal">Loyal</option>
                            <option value="at-risk">At Risk</option>
                            <option value="neutral">Neutral</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select class="form-select" id="priorityFilter">
                            <option value="">All Priorities</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Recommendation Type</label>
                        <select class="form-select" id="typeFilter">
                            <option value="">All Types</option>
                            <option value="upsell">Upsell</option>
                            <option value="retention">Retention</option>
                            <option value="engagement">Engagement</option>
                        </select>
                    </div>
                    <div class="form-group" style="display: flex; align-items: end;">
                        <button class="btn btn-secondary" onclick="applyFilters()">
                            <i data-lucide="filter"></i>Apply Filters
                        </button>
                    </div>
                </div>
            </div>

            <!-- Recommendations Grid -->
            <div class="recommendations-grid" id="recommendationsGrid">
                <!-- Recommendation cards will be populated by JavaScript -->
            </div>

            <!-- Export Options -->
            <div class="export-section">
                <div class="chart-card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3>Export Recommendations</h3>
                            <p style="color: var(--gray-600); margin: 0;">Download personalized recommendations for your team</p>
                        </div>
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn btn-secondary" onclick="exportRecommendations('csv')">
                                <i data-lucide="file-text"></i>Export CSV
                            </button>
                            <button class="btn btn-secondary" onclick="exportRecommendations('pdf')">
                                <i data-lucide="file"></i>Export PDF Report
                            </button>
                            <button class="btn btn-success" onclick="sendToSalesTeam()">
                                <i data-lucide="send"></i>Send to Sales Team
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <style>
        .strategy-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .strategy-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-md);
            border-left: 4px solid;
            transition: all 0.2s ease;
        }

        .strategy-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .strategy-card.loyal { border-left-color: var(--success); }
        .strategy-card.at-risk { border-left-color: var(--error); }
        .strategy-card.neutral { border-left-color: var(--warning); }

        .strategy-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .strategy-header i {
            width: 24px;
            height: 24px;
            color: var(--primary-blue);
        }

        .strategy-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .strategy-content p {
            color: var(--gray-600);
            margin-bottom: 1.5rem;
        }

        .strategy-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .stat {
            text-align: center;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: 8px;
        }

        .stat-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .stat-label {
            display: block;
            font-size: 0.75rem;
            color: var(--gray-600);
            font-weight: 500;
        }

        .recommendations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .recommendation-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-200);
            transition: all 0.2s ease;
        }

        .recommendation-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .rec-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .rec-customer {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .rec-avatar {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            background: linear-gradient(135deg, var(--primary-blue), #3b82f6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .rec-customer-info h4 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
        }

        .rec-customer-info p {
            margin: 0;
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .rec-priority {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .rec-priority.high { background: #fee2e2; color: var(--error); }
        .rec-priority.medium { background: #fef3c7; color: var(--warning); }
        .rec-priority.low { background: #dcfce7; color: var(--success); }

        .rec-content {
            margin-bottom: 1rem;
        }

        .rec-type {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--gray-100);
            color: var(--gray-700);
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-bottom: 0.75rem;
        }

        .rec-suggestion {
            font-size: 0.875rem;
            color: var(--gray-700);
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .rec-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .rec-metric {
            text-align: center;
            padding: 0.75rem;
            background: var(--gray-50);
            border-radius: 6px;
        }

        .rec-metric-value {
            display: block;
            font-weight: 600;
            color: var(--gray-900);
        }

        .rec-metric-label {
            display: block;
            font-size: 0.75rem;
            color: var(--gray-600);
        }

        .rec-actions {
            display: flex;
            gap: 0.5rem;
        }

        .rec-actions .btn {
            flex: 1;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .export-section {
            margin-top: 2rem;
        }
    </style>

    <script src="../database/telco.js"></script>
    <script src="../database/support.js"></script>
    <script src="../database/cdr.js"></script>
    <script src="../api/customers.js"></script>
    <script src="../api/recommendations.js"></script>
    <script src="../assets/js/main.js"></script>

    <script>
        let currentRecommendations = [];

        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            loadRecommendations();
        });

        function loadRecommendations() {
            currentRecommendations = generateSmartRecommendations();
            updateStrategyStats();
            renderRecommendations(currentRecommendations);
        }

        function generateSmartRecommendations() {
            const telcoData = window.telcoData || [];
            const supportData = window.supportData || [];
            const recommendations = [];

            telcoData.slice(0, 50).forEach((customer, index) => {
                const customerTickets = supportData.filter(t => t.customer_id === customer.customer_id);
                const avgSatisfaction = customerTickets.length > 0 
                    ? customerTickets.reduce((sum, t) => sum + (t.satisfaction_rating || 3), 0) / customerTickets.length
                    : 4;

                let segment, recType, priority, suggestion, acceptanceScore;

                // Determine segment and recommendation
                if (customer.tenure >= 24 && customer.churn === 'No' && avgSatisfaction >= 4) {
                    // Loyal Customer
                    segment = 'loyal';
                    recType = 'upsell';
                    priority = 'high';
                    suggestion = 'Offer premium bundle upgrade with enhanced features and priority support. Customer shows high engagement and satisfaction.';
                    acceptanceScore = Math.floor(Math.random() * 30) + 70; // 70-100%
                } else if (customer.tenure < 12 || customer.churn === 'Yes' || avgSatisfaction < 3) {
                    // At-Risk Customer
                    segment = 'at-risk';
                    recType = 'retention';
                    priority = customer.churn === 'Yes' ? 'high' : 'medium';
                    suggestion = 'Immediate retention offer with 20% discount and dedicated support. Address service concerns proactively.';
                    acceptanceScore = Math.floor(Math.random() * 40) + 30; // 30-70%
                } else {
                    // Neutral Customer
                    segment = 'neutral';
                    recType = 'engagement';
                    priority = 'medium';
                    suggestion = 'Introduce mid-tier service upgrades and personalized usage insights to increase engagement.';
                    acceptanceScore = Math.floor(Math.random() * 40) + 40; // 40-80%
                }

                const potentialRevenue = recType === 'upsell' ? 
                    customer.monthly_charges * 0.3 : 
                    customer.monthly_charges * 1.5; // Retention value

                recommendations.push({
                    id: `REC_${String(index + 1).padStart(3, '0')}`,
                    customer_id: customer.customer_id,
                    customer_name: `Customer ${customer.customer_id.split('_')[1]}`,
                    segment: segment,
                    type: recType,
                    priority: priority,
                    suggestion: suggestion,
                    acceptance_score: acceptanceScore,
                    potential_revenue: Math.round(potentialRevenue),
                    current_plan: customer.contract,
                    monthly_charges: customer.monthly_charges,
                    tenure: customer.tenure,
                    satisfaction: Math.round(avgSatisfaction * 10) / 10
                });
            });

            return recommendations;
        }

        function updateStrategyStats() {
            const loyal = currentRecommendations.filter(r => r.segment === 'loyal');
            const atRisk = currentRecommendations.filter(r => r.segment === 'at-risk');
            const neutral = currentRecommendations.filter(r => r.segment === 'neutral');

            document.getElementById('loyalRecommendations').textContent = loyal.length;
            document.getElementById('atRiskRecommendations').textContent = atRisk.length;
            document.getElementById('neutralRecommendations').textContent = neutral.length;

            // Calculate average conversion rates
            const loyalConversion = loyal.length > 0 ? loyal.reduce((sum, r) => sum + r.acceptance_score, 0) / loyal.length : 0;
            const retentionRate = atRisk.length > 0 ? atRisk.reduce((sum, r) => sum + r.acceptance_score, 0) / atRisk.length : 0;
            const engagementRate = neutral.length > 0 ? neutral.reduce((sum, r) => sum + r.acceptance_score, 0) / neutral.length : 0;

            document.getElementById('loyalConversionRate').textContent = Math.round(loyalConversion) + '%';
            document.getElementById('retentionRate').textContent = Math.round(retentionRate) + '%';
            document.getElementById('engagementRate').textContent = Math.round(engagementRate) + '%';
        }

        function renderRecommendations(recommendations) {
            const grid = document.getElementById('recommendationsGrid');
            
            grid.innerHTML = recommendations.map(rec => `
                <div class="recommendation-card">
                    <div class="rec-header">
                        <div class="rec-customer">
                            <div class="rec-avatar">${rec.customer_name.charAt(9)}</div>
                            <div class="rec-customer-info">
                                <h4>${rec.customer_name}</h4>
                                <p>${rec.customer_id} • ${rec.current_plan}</p>
                            </div>
                        </div>
                        <span class="rec-priority ${rec.priority}">${rec.priority.charAt(0).toUpperCase() + rec.priority.slice(1)}</span>
                    </div>

                    <div class="rec-content">
                        <span class="rec-type">${rec.type.charAt(0).toUpperCase() + rec.type.slice(1)} Opportunity</span>
                        <p class="rec-suggestion">${rec.suggestion}</p>
                    </div>

                    <div class="rec-metrics">
                        <div class="rec-metric">
                            <span class="rec-metric-value">${rec.acceptance_score}%</span>
                            <span class="rec-metric-label">Acceptance Score</span>
                        </div>
                        <div class="rec-metric">
                            <span class="rec-metric-value">$${rec.potential_revenue}</span>
                            <span class="rec-metric-label">Potential Revenue</span>
                        </div>
                    </div>

                    <div class="rec-actions">
                        <button class="btn btn-primary" onclick="implementRecommendation('${rec.id}')">
                            <i data-lucide="check"></i>Implement
                        </button>
                        <button class="btn btn-secondary" onclick="scheduleFollowUp('${rec.id}')">
                            <i data-lucide="calendar"></i>Schedule
                        </button>
                    </div>
                </div>
            `).join('');

            // Reinitialize Lucide icons
            lucide.createIcons();
        }

        function applyFilters() {
            const segmentFilter = document.getElementById('segmentFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;

            let filteredRecommendations = currentRecommendations;

            if (segmentFilter) {
                filteredRecommendations = filteredRecommendations.filter(r => r.segment === segmentFilter);
            }

            if (priorityFilter) {
                filteredRecommendations = filteredRecommendations.filter(r => r.priority === priorityFilter);
            }

            if (typeFilter) {
                filteredRecommendations = filteredRecommendations.filter(r => r.type === typeFilter);
            }

            renderRecommendations(filteredRecommendations);
        }

        function generateRecommendations() {
            window.mainApp.showNotification('Generating new recommendations...', 'info');
            
            setTimeout(() => {
                loadRecommendations();
                window.mainApp.showNotification('Recommendations updated successfully!', 'success');
            }, 1500);
        }

        function implementRecommendation(recId) {
            const rec = currentRecommendations.find(r => r.id === recId);
            window.mainApp.showNotification(`Implementing recommendation for ${rec.customer_name}...`, 'info');
            
            // In a real application, this would trigger the recommendation implementation
            setTimeout(() => {
                window.mainApp.showNotification('Recommendation implemented successfully!', 'success');
            }, 1000);
        }

        function scheduleFollowUp(recId) {
            const rec = currentRecommendations.find(r => r.id === recId);
            window.mainApp.showNotification(`Follow-up scheduled for ${rec.customer_name}`, 'info');
        }

        function exportRecommendations(format) {
            const exportData = currentRecommendations.map(rec => ({
                customer_id: rec.customer_id,
                customer_name: rec.customer_name,
                segment: rec.segment,
                recommendation_type: rec.type,
                priority: rec.priority,
                suggestion: rec.suggestion,
                acceptance_score: rec.acceptance_score + '%',
                potential_revenue: '$' + rec.potential_revenue,
                current_monthly_charges: '$' + rec.monthly_charges,
                tenure_months: rec.tenure,
                satisfaction_score: rec.satisfaction
            }));

            if (format === 'csv') {
                window.mainApp.downloadData(exportData, 'customer-recommendations', 'csv');
                window.mainApp.showNotification('Recommendations exported to CSV!', 'success');
            } else if (format === 'pdf') {
                // In a real implementation, this would generate a formatted PDF report
                window.mainApp.showNotification('PDF report generation would be implemented here', 'info');
            }
        }

        function sendToSalesTeam() {
            window.mainApp.showNotification('Recommendations sent to sales team!', 'success');
        }
    </script>
</body>
</html>